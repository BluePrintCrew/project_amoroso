name: í™˜ê²½ë³€ìˆ˜ ì—…ë¡œë“œ

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'í™˜ê²½ë³€ìˆ˜ë¥¼ ì—…ë¡œë“œí•  í™˜ê²½'
        required: true
        type: choice
        options:
          - dev
          - prod
      env_vars:
        description: 'ì—…ë¡œë“œí•  í™˜ê²½ë³€ìˆ˜ë“¤ (KEY=VALUE í˜•íƒœë¡œ í•œ ì¤„ì”© ì…ë ¥)'
        required: true
        type: string

env:
  AWS_REGION: ap-northeast-2

jobs:
  upload-environment-variables:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    permissions:
      id-token: write   # OIDC í† í° ìš”ì²­ì„ ìœ„í•´ í•„ìš”
      contents: read    # ì½”ë“œ ì²´í¬ì•„ì›ƒì„ ìœ„í•´ í•„ìš”

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²© ì¦ëª… êµ¬ì„±
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/github-actions-role-${{ github.event.inputs.environment }}
          role-session-name: GitHubActions-EnvVars-Upload
          aws-region: ${{ env.AWS_REGION }}

      - name: í™˜ê²½ë³€ìˆ˜ë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
        run: |
          echo "ğŸ“ í™˜ê²½ë³€ìˆ˜ íŒŒì‹± ì¤‘..."
          
          # ì…ë ¥ë°›ì€ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„ì‹œ íŒŒì¼ì— ì €ì¥
          cat << 'EOF' > /tmp/env_vars.env
          ${{ github.event.inputs.env_vars }}
          EOF
          
          echo "âœ… í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo "íŒŒì¼ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° (ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹):"
          sed 's/\(.*=\).*/\1***MASKED***/g' /tmp/env_vars.env

      - name: SSM Parameter Storeì— í™˜ê²½ë³€ìˆ˜ ì—…ë¡œë“œ
        run: |
          echo "ğŸš€ AWS Parameter Storeì— í™˜ê²½ë³€ìˆ˜ ì—…ë¡œë“œ ì¤‘..."
          
          ENV="${{ github.event.inputs.environment }}"
          PREFIX="/${ENV}/amoroso"
          ENV_FILE="/tmp/env_vars.env"
          
          echo "í™˜ê²½: $ENV"
          echo "ì ‘ë‘ì‚¬: $PREFIX"
          
          # ì•”í˜¸í™”í•  ë³€ìˆ˜ë“¤ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
          SECURE_PARAMS=("password" "secret" "key" "token" "credential")
          
          SUCCESS_COUNT=0
          ERROR_COUNT=0
          
          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì½ê¸° ë° íŒŒë¼ë¯¸í„° ìŠ¤í† ì–´ì— ì—…ë¡œë“œ
          while IFS='=' read -r key value || [ -n "$key" ]; do
            # ì£¼ì„ì´ë‚˜ ë¹ˆ ì¤„ ë¬´ì‹œ
            if [[ $key =~ ^#.* ]] || [[ -z "$key" ]]; then
              continue
            fi
            
            # ë³€ìˆ˜ ì´ë¦„ê³¼ ê°’ ì •ë¦¬ (ê³µë°± ì œê±°)
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            
            # ë¹ˆ í‚¤ë‚˜ ê°’ ê±´ë„ˆë›°ê¸°
            if [[ -z "$key" ]] || [[ -z "$value" ]]; then
              continue
            fi
            
            # íŒŒë¼ë¯¸í„° ì´ë¦„ ìƒì„± (ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ê³  _ ëŒ€ì‹  - ì‚¬ìš©)
            param_name=$(echo "$key" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
            param_path="${PREFIX}/${param_name}"
            
            # ë¯¼ê°í•œ ì •ë³´ì¸ì§€ í™•ì¸
            is_secure=false
            for secure in "${SECURE_PARAMS[@]}"; do
              if [[ "$param_name" == *"$secure"* ]]; then
                is_secure=true
                break
              fi
            done
            
            # íŒŒë¼ë¯¸í„° ì €ì¥
            if [ "$is_secure" = true ]; then
              echo "ğŸ”’ SecureString ì €ì¥ ì¤‘: ${param_path}"
              aws ssm put-parameter \
                --name "${param_path}" \
                --value "${value}" \
                --type "SecureString" \
                --overwrite \
                --no-cli-pager
            else
              echo "ğŸ“ String ì €ì¥ ì¤‘: ${param_path}"
              aws ssm put-parameter \
                --name "${param_path}" \
                --value "${value}" \
                --type "String" \
                --overwrite \
                --no-cli-pager
            fi
            
            if [ $? -eq 0 ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âŒ ì˜¤ë¥˜: '${param_path}' íŒŒë¼ë¯¸í„° ì €ì¥ ì‹¤íŒ¨"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done < "$ENV_FILE"
          
          echo ""
          echo "============================================================"
          echo "ğŸ‰ í™˜ê²½ë³€ìˆ˜ ì—…ë¡œë“œ ì™„ë£Œ!"
          echo "ì„±ê³µ: $SUCCESS_COUNTê°œ"
          echo "ì‹¤íŒ¨: $ERROR_COUNTê°œ"
          echo "í™˜ê²½: $ENV"
          echo "ì ‘ë‘ì‚¬: $PREFIX"
          echo "============================================================"
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âš ï¸ ì¼ë¶€ í™˜ê²½ë³€ìˆ˜ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: ì—…ë¡œë“œëœ íŒŒë¼ë¯¸í„° í™•ì¸
        run: |
          echo "ğŸ” ì—…ë¡œë“œëœ íŒŒë¼ë¯¸í„° ëª©ë¡ í™•ì¸ ì¤‘..."
          PREFIX="/${{ github.event.inputs.environment }}/amoroso"
          
          aws ssm get-parameters-by-path \
            --path "$PREFIX" \
            --recursive \
            --query "Parameters[*].{Name:Name,Type:Type}" \
            --output table
          
          echo ""
          echo "âœ… íŒŒë¼ë¯¸í„° í™•ì¸ ì™„ë£Œ!"
          echo "ğŸ’¡ ë¯¼ê°í•œ ê°’ë“¤ì„ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì„¸ìš”:"
          echo "aws ssm get-parameters-by-path --path \"$PREFIX\" --recursive --with-decryption"

      - name: ì—…ë¡œë“œ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ğŸ”§ í™˜ê²½ë³€ìˆ˜ ì—…ë¡œë“œ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **í™˜ê²½**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì ‘ë‘ì‚¬**: /${{ github.event.inputs.environment }}/amoroso" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ**: âœ… ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ ì…ë ¥ëœ í™˜ê²½ë³€ìˆ˜ë“¤" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo '${{ github.event.inputs.env_vars }}' | sed 's/\(.*=\).*/\1***MASKED***/g' >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY